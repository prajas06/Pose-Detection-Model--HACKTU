<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pose Session (Simple)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    video { width: 360px; max-width: 90vw; border: 1px solid #ccc; border-radius: 8px; }
    .row { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    select, input, button { padding: 8px; font-size: 14px; }
    pre { background: #f6f6f6; padding: 10px; border-radius: 8px; overflow: auto; }
    .small { font-size: 12px; color: #555; }
  </style>
</head>
<body>
  <h2>Exercise Session</h2>

  <video id="video" autoplay playsinline muted></video>

  <div class="row">
    <label>Exercise:</label>
    <select id="exercise">
      <option value="squat">squat</option>
      <option value="curl">curl</option>
      <option value="press">press</option>
    </select>

    <label>Target Reps:</label>
    <input id="targetReps" type="number" value="10" min="1" style="width:90px" />

    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>

  <p class="small">
    Make sure your FastAPI is running (uvicorn) and this page uses the same host/port.
  </p>

  <h3>Live</h3>
  <pre id="live">Waiting…</pre>

  <h3>Final Report</h3>
  <pre id="final">—</pre>

  <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const liveEl = document.getElementById("live");
    const finalEl = document.getElementById("final");

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const exerciseEl = document.getElementById("exercise");
    const targetRepsEl = document.getElementById("targetReps");

    let ws = null;
    let stream = null;
    let sendTimer = null;

    // CHANGE THIS if your API is on another host/port
    // Example: ws://127.0.0.1:8000/ws/session
    const WS_URL = (() => {
      const proto = (location.protocol === "https:") ? "wss" : "ws";
      return `${proto}://${location.host}/ws/session`;
    })();

    async function startCamera() {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { width: 640, height: 480 },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
    }

    function connectWS() {
      return new Promise((resolve, reject) => {
        ws = new WebSocket(WS_URL);
        ws.binaryType = "arraybuffer";

        ws.onopen = () => resolve();
        ws.onerror = (e) => reject(e);

        ws.onmessage = (evt) => {
          try {
            const msg = JSON.parse(evt.data);
            if (msg.type === "live") {
              liveEl.textContent = JSON.stringify(msg, null, 2);
            }
            if (msg.type === "final_report") {
              finalEl.textContent = JSON.stringify(msg.report, null, 2);
              stopAll(); // auto-stop when done
            }
          } catch (err) {
            // if server ever sends non-json
            console.log("WS message:", evt.data);
          }
        };

        ws.onclose = () => {
          // just show closed state
        };
      });
    }

    function sendStart() {
      const payload = {
        type: "start",
        exercise: exerciseEl.value,
        target_reps: Number(targetRepsEl.value || 10)
      };
      ws.send(JSON.stringify(payload));
    }

    async function sendFrameOnce() {
      if (!ws || ws.readyState !== 1) return;
      if (!video.videoWidth || !video.videoHeight) return;

      // draw webcam frame to canvas
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // encode to JPEG and send bytes
      const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg", 0.7));
      if (!blob) return;

      const buf = await blob.arrayBuffer();
      ws.send(buf);
    }

    function startSendingFrames() {
      // ~12 fps (simple + stable)
      sendTimer = setInterval(sendFrameOnce, 80);
    }

    function stopSendingFrames() {
      if (sendTimer) {
        clearInterval(sendTimer);
        sendTimer = null;
      }
    }

    async function startAll() {
      finalEl.textContent = "—";
      liveEl.textContent = "Connecting…";

      startBtn.disabled = true;
      stopBtn.disabled = false;

      await startCamera();
      await connectWS();
      sendStart();
      startSendingFrames();

      liveEl.textContent = "Started. Sending frames…";
    }

    function stopAll() {
      stopSendingFrames();

      if (ws) {
        try { ws.close(); } catch(e) {}
        ws = null;
      }

      stopCamera();

      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    startBtn.addEventListener("click", () => {
      startAll().catch(err => {
        console.error(err);
        liveEl.textContent = "Error: " + (err?.message || err);
        stopAll();
      });
    });

    stopBtn.addEventListener("click", stopAll);
  </script>
</body>
</html>
